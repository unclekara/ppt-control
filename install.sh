#!/bin/bash

set -e  # ÐŸÑ€ÐµÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ppt-control..."

# 1. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
USER=$(whoami)
INSTALL_DIR="/home/$USER/ppt-control"

# 2. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
sudo apt update && sudo apt upgrade -y

# 3. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
sudo apt install -y git curl nodejs npm pm2

# 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js (ÐµÑÐ»Ð¸ Ð²ÐµÑ€ÑÐ¸Ñ Ð½Ð¸Ð¶Ðµ 16)
NODE_VERSION=$(node -v 2>/dev/null || echo "none")
if [[ "$NODE_VERSION" == "none" || "$NODE_VERSION" < "v16" ]]; then
    echo "âš¡ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Node.js Ð´Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¸ 18..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt install -y nodejs
fi

# 5. ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚ (ÐµÑÐ»Ð¸ Ð½Ðµ Ð±Ñ‹Ð» ÑÐºÐ°Ñ‡Ð°Ð½)
if [ ! -d "$INSTALL_DIR" ]; then
    echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
    git clone https://github.com/unclekara/ppt-control.git "$INSTALL_DIR"
fi

cd "$INSTALL_DIR"

# 6. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ npm-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° npm-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
npm install

# 7. ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ pm2 Ð¸ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° pm2..."
pm2 stop ppt-server || true  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°, ÐµÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
pm2 start server.js --name "ppt-server"
pm2 save
pm2 startup | grep "sudo" | bash  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°

echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°! Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½."
echo "ðŸ’¡ ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°Ð¹ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ: http://<IP-ÑÐµÑ€Ð²ÐµÑ€Ð°>"
